@model BJProduction.Models.Transfer_Order

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/index.cshtml";
}
<head>
    <link href="~/Content/Exp/Select2.css" rel="stylesheet" />
    <link href="~/Content/Exp/select2-bootstrap4.css" rel="stylesheet" />
    <!-- select2-bootstrap4-theme -->

</head>

<div class="row">
    <div class="col-lg-12">
        <div class="main-card mb-3 card">
            @using (Html.BeginForm())
            {
                <div class="card-header-tab card-header">
                    <div class="card-header-title font-size-lg text-capitalize font-weight-normal"><i class="header-icon lnr-laptop-phone mr-3 text-muted opacity-6"> </i>Create</div>
                    <div class="btn-actions-pane-right actions-icon-btn">
                        @Html.ActionLink("Back to List", "Index", null, new { @class = "btn-shadow btn btn-info" })
                    </div>
                </div>

                <div class="card-body">
                    @Html.AntiForgeryToken()



                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    @*@Html.HiddenFor(model => model.id)*@

                    <div class="form-row">
                        <div class="col-md-2">
                            <div class="position-relative form-group">
                                @Html.LabelFor(model => model.order_no, htmlAttributes: new { @class = "" })

                                @Html.EditorFor(model => model.order_no, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.order_no, "", new { @class = "text-danger" })

                            </div>
                        </div>
                    </div>

                    <div class="form-row">

                        <div class="col-md-2">
                            <div class="position-relative form-group">
                                @Html.LabelFor(model => model.Product_Typeid, "Product_Typeid", htmlAttributes: new { @class = "" })

                                @Html.DropDownList("Product_Typeid", null, htmlAttributes: new { @class = "form-control" })
                                @Html.ValidationMessageFor(model => model.Product_Typeid, "", new { @class = "text-danger" })

                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="position-relative form-group">
                                @Html.LabelFor(model => model.qty, htmlAttributes: new { @class = "" })

                                @Html.EditorFor(model => model.qty, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.qty, "", new { @class = "text-danger" })

                            </div>
                        </div>


                        <div class="col-md-2">
                            <div class="position-relative form-group">
                                @Html.LabelFor(model => model.transfer_from_date, htmlAttributes: new { @class = "" })

                                @Html.EditorFor(model => model.transfer_from_date, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.transfer_from_date, "", new { @class = "text-danger" })

                            </div>
                        </div>

                        <div class="col-md-2 offset-md-2 MainFeature">

                        </div>
                        <div class="col-md-2 MainUnit">

                        </div>
                    </div>

                    <div id="DynaComb" class="">
                        <div id="1" class="form-row">
                            <div class="col-md-2">
                            </div>
                        </div>
                    </div>
                    <div id="DynaComb2" class="">
                        <div id="1" class="form-row">
                            <div class="col-md-2">
                            </div>
                        </div>
                    </div>


                </div>

            }
        </div>
    </div>
</div>



<div id="" class="" style="">
    <div class="row">
        <div class="col-md-6">
            <div class="main-card mb-3 card">
                <div class="card-body">
                    <h5 class="card-title">From</h5>

                    <div class="form-row">

                        <div class="col-md-12">
                            <div class="position-relative form-group">
                                <label for="" class="">From Company</label>
                                <select id="Company1" class="form-control Company"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="position-relative form-group">
                                <label for="" class="">From Site</label>
                                <select id="Site1" class="form-control Site"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="position-relative form-group">
                                <label for="" class="">From Warehouse</label>
                                <select id="Warehouse1" class="form-control Warehouse"></select>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

        </div>
        <div class="col-md-6">
            <div class="main-card mb-3 card">
                <div class="card-body">
                    <h5 class="card-title">To</h5>
                    <div class="form-row">
                        <div class="col-md-12">
                            <div class="position-relative form-group">
                                <label for="" class="">To Company</label>
                                <select id="Company2" class="form-control Company"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="position-relative form-group">
                                <label for="" class="">To Site</label>
                                <select id="Site2" class="form-control Site"></select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="position-relative form-group">
                                <label for="" class="">To Warehouse</label>
                                <select id="Warehouse2" class="form-control Warehouse"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="col-md-12">
            <div class="main-card mb-3 card">
                <div class="card-body">
                    <h5 class="card-title">Product to Transfer</h5>
                    <div class="form-row">
                        <div class="col-md-11">
                            <div class="position-relative form-group">
                                <label for="" class="">Product Serial</label>
                                <select class="Products form-control" multiple>
                                    <option value="1">2100000133</option>
                                    <option value="2">2100000144</option>
                                    <option value="3">2100000155</option>
                                    <option value="4">2100000166</option>
                                    <option value="5">2100000177</option>
                                    <option value="6">2100000188</option>
                                    <option value="7">2100000199</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-1">
                            <div class="position-relative form-group">
                                <label for="" class="" style="color:white"> .</label>
                                <button id="TransferBtn" class="mb-2 mr-2 btn btn-success btn-primary btn-lg btn-block">
                                    Transfer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>





<div class="Button_Section" style=" position: fixed; bottom: 40px; right: 40px">
    <button class="btn btn-danger btn-lg">Cancel</button>
    <button id="SaveBtn" class="btn btn-success btn-lg">Save</button>

</div>


@section scripts{

    <script type="text/javascript">

        $(document).ready(function () {
            $(".Products").select2({
                theme: 'bootstrap4',
                closeOnSelect: false
            });


            LoadCompany("Company1");
            LoadCompany("Company2");
            LoadDynamicFeature( $("#Product_Typeid").val());
            console.log($('.m').val())
        })




        // Functions


        function LoadCompany(HTMLEId) {
    $.ajax({
        type: "POST",
        url: '@Url.Action("GetCompany", "Home")',
        contentType: "application/json; charset=utf-8",
       // async: false,
        data: JSON.stringify(null),
        success: function(data) {
            $("#" + HTMLEId).empty();
            $("#" + HTMLEId).append("<option value=\"Please select\">Please Select a Company</option>")
            $.each(data, function(key, value) {
                $("#" + HTMLEId).append("<option value=" + value.Id + ">" + value.Company_Name + "</option>")
            });
          //  LoadSite($("#"+HTMLEId).val(), "Load");
        }
    });
        }

        function LoadSite(companyid, HTMLEId) {

    var json = {
        id: companyid
    }
    $.ajax({
        type: "POST",
        url: '@Url.Action("GetSite", "Home")',
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify(json),
        success: function(data) {
            $("#Site" + HTMLEId).empty();
            $.each(data, function (key, value) {
                $("#Site" + HTMLEId).append("<option value=\"" + value.Locations.id + "\">" + value.Locations.name + "</option>");
            });
            LoadWarehouse($("#Site" + HTMLEId).val(), HTMLEId);
        }
    });
        }



        function LoadWarehouse(siteId,HTMLEId) {

    $.ajax({
        type: "POST",
        url: '@Url.Action("GetWh", "Purchase_Order")',
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
            id: siteId
        }),
        success: function (data) {
            $("#Warehouse" + HTMLEId).empty();
            $.each(data, function(key, value) {
                //alert("hi");
                $("#Warehouse" + HTMLEId).append("<option value=\"" + value.id + "\">" + value.name + "</option>");

            });
        }
    });

}




       function LoadDynamicFeature(productid) {
    $.ajax({
        type: "POST",
        url: '@Url.Action("GetFid", "Purchase_Order")',
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
            id: productid
        }),
                success: function(data) {
                $("#Featureid").empty();
                $("#DynaComb").empty();
                $("#DynaComb2").empty();
                $(".MainFeature").empty();
                $(".MainUnit").empty();
               // $("#Featureid").append("<option value=" + ">" + "---- Please Select Feature ----" + "</option>")
                var CounterA = 0;
                var CounterB = 1;
                var CounterC = 0;
                var CounterD = 1;
                $.each(data, function (key, value) {

                    if (value.status != "M" && value.Feature_Type.status!="T") {
                        if (CounterA == 0) {
                            $("#DynaComb").append("<div class=\"form-row\"></div>")
                        }
                        $("#DynaComb>:nth-child(" + CounterB + ")").append("<div class=\"col-md-2\"><div class=\"position-relative form-group\" ><label for=\"\" class=\"\">" + value.Feature_Type.type_name + "</label><select id=\"" + value.Feature_Type.id + "\"  class=\"form-control Features\ AllItem" + value.Feature_Type.id + "\"></select></div></div>")
                        //$("#Featureid").append("<option value=" + value.Feature_Type.id + ">" + value.Feature_Type.type_name + "</option>")
                        CounterA++;
                        if (CounterA >= 6) {
                            CounterB++;
                            CounterA = 0;
                        }
                    }


                    else {

                        if (value.Feature_Type.status == "T" && value.status!="M")  {


                                if (CounterC == 0) {
                                    $("#DynaComb2").append("<div class=\"form-row\"></div>")
                                }
                                $("#DynaComb2>:nth-child(" + CounterD + ")").append("<div class=\"col-md-2\"><div class=\"position-relative form-group\" ><label for=\"\" class=\"\">" + value.Feature_Type.type_name + "</label><input id=\"" + value.Feature_Type.id + "\"  class=\"form-control FeaturesTxtBox\ Text" + value.Feature_Type.id + "\"></input></div></div>")
                            $("#DynaComb2>:nth-child(" + CounterD + ")").append("<div class=\"col-md-2\"><div class=\"position-relative form-group\" ><label for=\"\" class=\"\">Unit</label><select id=\"" + value.Feature_Type.id + "\"  class=\"form-control FeaturesTxtBoxUnit DynaComb2FeatureUnit" + value.Feature_Type.id + "\"></select></div></div>")

                             $.ajax({
                            type: "POST",
                            url: '@Url.Action("GetUnit", "Purchase_Order")',
                                 contentType: "application/json; charset=utf-8",

                                 data: JSON.stringify({ id: value.Feature_Type.id }),
                            success: function(Unitdata) {

                                $.each(Unitdata, function(key, Unitvalue) {
                                    $(".DynaComb2FeatureUnit" + value.Feature_Type.id).append("<option value=\"" + Unitvalue.Unit_Measurement.id + "\">" + Unitvalue.Unit_Measurement.code + "</option>");
                                    $(".Text" + value.Feature_Type.id).attr("UnitValue", $(".DynaComb2FeatureUnit" + value.Feature_Type.id).val());
                                });
                                $(document.body).on("change", ".FeaturesTxtBoxUnit", function () {
                                    $(".Text" + $(this).attr("id")).attr("UnitValue", $(this).val())
                                })
                            }
                        });


                               CounterC++;
                                if (CounterC >= 3) {
                                    CounterD++;
                                    CounterC = 0;
                                }

                        }
                        else{
                        $(".MainFeature").append("<div class= \"position-relative form-group\" ><label for=\"\" class=\"\">" + value.Feature_Type.type_name + "</label><input id=\"MainFeatureValue\" class=\"form-control\"></div>")
                        mainFeatureId = value.Feature_Type.id;
                        var json = {
                            id: mainFeatureId
                        }
                        $.ajax({
                            type: "POST",
                            url: '@Url.Action("GetUnit", "Purchase_Order")',
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(json),
                            success: function(data) {

                                $(".MainUnit").append("<div class=\"position-relative form-group\"><label for=\"\" class=\"\">Unit</label><select class=\"form-control\" id=\"MainUnit\"></select></div>");
                                $.each(data, function(key, value) {
                                    $("#MainUnit").append("<option value=\"" + value.Unit_Measurement.id + "\">" + value.Unit_Measurement.code + "</option>");
                                });
                            }
                        });
                     }
                  }
            });
            $(".Features").each(function() {
                var fid = this.id;
                if (fid != undefined && fid != '') {
                    var json2 = {
                        id: fid
                    }
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("GetFt", "Purchase_Order")',
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(json2),
                        success: function(data) {

                            $.each(data, function(key, value) {
                                $('#' + fid).append("<option value=\"" + value.id + "\">" + value.feature_name + "</option>");
                            });

                            // Loop dynamic attr value
                            //for (let i = 0; i < AllData[3].length; i++) {
                            //    $('#' + AllData[3][i].Feature.Feature_Typeid).val(AllData[3][i].Feature.id);
                            //}
                        }
                    });
                }
            })
        }
    });
}








        // Change Events
        var i = 1, j = 2;
        $(document).on("change", "#Company" + i, (function () {
            LoadSite($(this).val(), i);
        }))

        $(document).on("change", "#Company" + j, (function () {
            LoadSite($(this).val(), j);

        }))

        $(document).on("change", "#Site" + i, (function () {
            LoadWarehouse($(this).val(), i);
        }))

        $(document).on("change", "#Site" + j, (function () {
            LoadWarehouse($(this).val(), j);

        }))

        $(document).on("change", "#Product_Typeid", (function () {
            LoadDynamicFeature($(this).val());

        }))




        // Global Variables

        var orderNo, productTypeId, qty, transferDate, fromCompany, toCompany, fromSite, toSite, fromWarehouse, toWarehouse, transferCount, unitId, mainFeatureId;
        var Dynamic_Attr = [], VarData = [], DTS = [], Dynamic_AttrTxt = [];

        // Click Events


                       $("#SaveBtn").click(function () {
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": false,
                "progressBar": true,
                "positionClass": "toast-top-full-width",
                "preventDuplicates": true,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "30000",
                "extendedTimeOut": "30000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }

            VarData, Dynamic_Attr, DTS = null;

                    orderNo = $("#order_no").val();
                    productTypeId = $("#Product_Typeid").val();
                    qty = $("#qty").val();
                    transferDate = $("#transfer_from_date").val();
                    fromCompany = $("#Company1").val();
                    toCompany = $("#Company2").val();
                    fromSite = $("#Site1").val();
                    toSite = $("#Site2").val();
                    fromWarehouse = $("#Warehouse1").val();
                    toWarehouse = $("#Warehouse2").val();

            //mainFeatureId = $("#").val();
            transferCount = $("#MainFeatureValue").val();
            unitId = $("#MainUnit").val();

                    VarData = [orderNo, productTypeId, qty, transferDate, fromCompany, toCompany, fromSite, toSite, fromWarehouse, toWarehouse, transferCount, unitId, mainFeatureId]

            $("#DynaComb > div > div > div > select").each(function () {
                Dyna_Id = this.getAttribute('id');
                Dyna_Value = $(this).val();
                Dynamic_Attr.push([this.getAttribute('id'), $(this).val()]);
            });
            $("#DynaComb2 > div > div > div > input").each(function () {
                Dyna_Id = this.getAttribute('id');
                Dyna_Value = $(this).val();
                alert($(this).attr("unitvalue"))
                Dynamic_AttrTxt.push([this.getAttribute('id'), $(this).val(), $(this).attr("unitvalue")]);
            });


            DTS = [VarData, Dynamic_Attr, Dynamic_AttrTxt];
            console.log(DTS);


            var postData = { values: DTS };
                  $.ajax({
                    type: "POST",
                    url: '@Url.Action("SaveData", "Transfer_Order")',
                    contentType: "application/json; charset=utf-8",
                      data: JSON.stringify(postData),
                      success: function (data) {
                          location.replace('@Url.Action("Edit", "Transfer_Order")'+"/"+data);

                          alert(data);
                          if (data[0].length != null) {

                              toastr.error(data[0], data[0].length);
                          }
                          else {
                              toastr.success(data[0], data[0].length);
                          }
                      }
                });

            $("#Start").prop("disabled", false);
            $(this).prop("disabled", true);

        });






        // ###########################################################################################

        //var cls = "Company"
        //$(document.body).on("change", "select." + cls + "", function () {
        //    var selectedItems = [];
        //    var prevSelectedItem = $(this).data("key");
        //    if (prevSelectedItem) {
        //        var index = selectedItems.indexOf(prevSelectedItem);
        //        if (index > -1) {
        //            selectedItems.splice(index, 1);
        //        }
        //        $("select." + cls + " option[value='" + prevSelectedItem + "']").show();
        //    }

        //    var selectedItem = $(this).val();
        //    if (selectedItem === "Please select") {
        //        return;
        //    }

        //    if (selectedItems.includes(selectedItem)) {
        //        $(this).val("Please select");
        //        return;
        //    }

        //    selectedItems.push(selectedItem);
        //    $(this).data("key", selectedItem);

        //    $("select." + cls).each(function () {
        //        if ($(this).val() === selectedItem) {
        //            return;
        //        }
        //        $(this)
        //            .find("option[value='" + selectedItem + "']")
        //            .hide();
        //    });
        //});

    </script>

}